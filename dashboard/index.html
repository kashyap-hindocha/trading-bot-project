<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ALGO DESK — Trading Bot</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
  :root {
    --bg:       #080b0f;
    --bg2:      #0d1117;
    --bg3:      #131920;
    --border:   #1e2a35;
    --accent:   #00e5ff;
    --green:    #00ff88;
    --red:      #ff3b5c;
    --yellow:   #ffd230;
    --text:     #c8d8e8;
    --muted:    #4a6070;
    --glow:     rgba(0,229,255,0.12);
    --glow2:    rgba(0,255,136,0.10);
    --shadow:   rgba(0,0,0,0.45);
    --font-mono: 'Space Mono', monospace;
    --font-head: 'Syne', sans-serif;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background:
      radial-gradient(1200px 600px at 10% -10%, rgba(0,229,255,0.12), transparent 60%),
      radial-gradient(900px 500px at 90% 10%, rgba(0,255,136,0.10), transparent 60%),
      linear-gradient(180deg, #070a0e 0%, #0a0f14 45%, #0b0f16 100%);
    color: var(--text);
    font-family: var(--font-mono);
    font-size: 13px;
    min-height: 100vh;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.03) 2px, rgba(0,0,0,0.03) 4px);
    pointer-events: none;
    z-index: 9999;
  }

  body::after {
    content: '';
    position: fixed;
    inset: 0;
    background:
      radial-gradient(400px 200px at 15% 20%, rgba(0,229,255,0.18), transparent 70%),
      radial-gradient(380px 220px at 85% 30%, rgba(255,210,48,0.12), transparent 70%);
    mix-blend-mode: screen;
    pointer-events: none;
    z-index: 0;
  }

  /* Mobile responsiveness */
  @media (max-width: 900px) {
    header {
      flex-wrap: wrap;
      gap: 12px;
    }
    .header-right {
      width: 100%;
      justify-content: flex-start;
      flex-wrap: wrap;
      gap: 10px;
    }
    main {
      grid-template-columns: 1fr;
      padding: 16px;
    }
    .stat-row {
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .chart-panel.wide,
    .chart-panel.side,
    .table-panel,
    .logs-panel,
    .coin-manager {
      grid-column: 1 / -1;
    }
    .chart-wrap { height: 180px; }
    .coin-grid { grid-template-columns: 1fr; }
    .table-panel table {
      display: block;
      overflow-x: auto;
      white-space: nowrap;
    }
  }

  @media (max-width: 600px) {
    .logo { font-size: 16px; letter-spacing: 0.12em; }
    .card-value { font-size: 22px; }
    .stat-row { grid-template-columns: 1fr; }
    .toggle-btn, .mode-btn { width: 100%; text-align: center; }
    .panel-title { font-size: 9px; }
    .chart-wrap { height: 160px; }
  }

  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 18px 28px;
    border-bottom: 1px solid var(--border);
    background: linear-gradient(180deg, rgba(13,17,23,0.95), rgba(11,15,20,0.85));
    backdrop-filter: blur(6px);
    box-shadow: 0 6px 20px var(--shadow);
    position: sticky;
    top: 0;
    z-index: 100;
  }

  .logo {
    font-family: var(--font-head);
    font-size: 20px;
    font-weight: 800;
    letter-spacing: 0.15em;
    color: var(--accent);
    text-transform: uppercase;
    text-shadow: 0 0 18px rgba(0,229,255,0.35);
  }
  .logo span { color: var(--muted); font-weight: 400; }

  .header-right {
    display: flex;
    align-items: center;
    gap: 14px;
  }

  .status-pill {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 5px 14px;
    border: 1px solid var(--border);
    border-radius: 2px;
    font-size: 11px;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    background: rgba(19,25,32,0.7);
    box-shadow: inset 0 0 0 1px rgba(255,255,255,0.02);
  }

  .dot {
    width: 7px; height: 7px;
    border-radius: 50%;
    background: var(--muted);
  }
  .dot.live { background: var(--green); animation: pulse 2s infinite; }
  .dot.stopped { background: var(--red); }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50%       { opacity: 0.3; }
  }

  .last-update { color: var(--muted); font-size: 11px; }

  /* Toggle button */
  .toggle-btn {
    padding: 7px 22px;
    border: none;
    border-radius: 2px;
    font-family: var(--font-mono);
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: 0 8px 20px rgba(0,0,0,0.35);
  }
  .toggle-btn.start {
    background: rgba(0,255,136,0.12);
    color: var(--green);
    border: 1px solid rgba(0,255,136,0.35);
  }
  .toggle-btn.start:hover { background: rgba(0,255,136,0.22); }
  .toggle-btn.stop {
    background: rgba(255,59,92,0.12);
    color: var(--red);
    border: 1px solid rgba(255,59,92,0.35);
  }
  .toggle-btn.stop:hover { background: rgba(255,59,92,0.22); }
  .toggle-btn:disabled { opacity: 0.35; cursor: not-allowed; }

  .mode-btn {
    padding: 6px 14px;
    border: 1px solid var(--border);
    border-radius: 2px;
    font-family: var(--font-mono);
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    cursor: pointer;
    background: var(--bg3);
    color: var(--text);
    transition: all 0.2s;
    box-shadow: inset 0 0 0 1px rgba(255,255,255,0.02);
  }
  .mode-btn.real { border-color: rgba(0,229,255,0.4); color: var(--accent); }
  .mode-btn.paper { border-color: rgba(255,210,48,0.5); color: var(--yellow); }
  .mode-btn:hover { border-color: var(--accent); }

  /* Layout */
  main {
    padding: 24px 28px;
    display: grid;
    grid-template-columns: 1fr 1fr 1fr 1fr;
    gap: 16px;
    position: relative;
    z-index: 1;
  }

  .stat-row {
    grid-column: 1 / -1;
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
  }

  .card {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 2px;
    padding: 20px;
    position: relative;
    overflow: hidden;
    transition: border-color 0.2s, transform 0.2s, box-shadow 0.2s;
    box-shadow: 0 10px 24px var(--shadow);
  }
  .card:hover {
    border-color: var(--accent);
    transform: translateY(-2px);
    box-shadow: 0 16px 32px rgba(0,0,0,0.45);
  }
  .card::before {
    content: '';
    position: absolute;
    top: 0; left: 0;
    width: 3px; height: 100%;
    background: var(--accent);
    opacity: 0.5;
  }
  .card.green::before  { background: var(--green); }
  .card.red::before    { background: var(--red); }
  .card.yellow::before { background: var(--yellow); }

  .card-label {
    font-size: 10px;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 10px;
  }
  .card-value {
    font-family: var(--font-head);
    font-size: 28px;
    font-weight: 800;
    line-height: 1;
  }
  .card-value.green  { color: var(--green); }
  .card-value.red    { color: var(--red); }
  .card-value.accent { color: var(--accent); }
  .card-sub { margin-top: 6px; font-size: 11px; color: var(--muted); }

  .chart-panel {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 2px;
    padding: 20px;
    box-shadow: 0 10px 24px var(--shadow);
  }
  .chart-panel.wide { grid-column: span 3; }
  .chart-panel.side { grid-column: span 1; }

  .panel-title {
    font-size: 10px;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .panel-title::after { content: ''; flex: 1; height: 1px; background: var(--border); }

  .panel-tools {
    display: flex;
    gap: 10px;
    align-items: center;
    margin-left: auto;
  }
  .panel-tools input,
  .panel-tools select {
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: 2px;
    color: var(--text);
    font-family: var(--font-mono);
    font-size: 11px;
    padding: 6px 8px;
  }
  .panel-tools input:focus,
  .panel-tools select:focus { outline: none; border-color: var(--accent); }

  .panel-tools {
    display: flex;
    gap: 10px;
    align-items: center;
    margin-left: auto;
  }
  .panel-tools input,
  .panel-tools select {
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: 2px;
    color: var(--text);
    font-family: var(--font-mono);
    font-size: 11px;
    padding: 6px 8px;
  }
  .panel-tools input:focus,
  .panel-tools select:focus { outline: none; border-color: var(--accent); }

  .chart-wrap { position: relative; height: 200px; }

  .table-panel {
    grid-column: span 4;
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 2px;
    padding: 20px;
    box-shadow: 0 10px 24px var(--shadow);
  }

  table { width: 100%; border-collapse: collapse; }
  thead th {
    font-size: 10px;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--muted);
    text-align: left;
    padding: 8px 12px;
    border-bottom: 1px solid var(--border);
  }
  tbody tr { border-bottom: 1px solid rgba(30,42,53,0.5); transition: background 0.15s; }
  tbody tr:hover { background: var(--bg3); }
  tbody td { padding: 10px 12px; font-size: 12px; }

  .badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 2px;
    font-size: 10px;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    font-weight: 700;
  }
  .badge.buy    { background: rgba(0,255,136,0.1);  color: var(--green);  border: 1px solid rgba(0,255,136,0.3); }
  .badge.sell   { background: rgba(255,59,92,0.1);   color: var(--red);    border: 1px solid rgba(255,59,92,0.3); }
  .badge.open   { background: rgba(0,229,255,0.1);  color: var(--accent); border: 1px solid rgba(0,229,255,0.3); }
  .badge.closed { background: rgba(74,96,112,0.2);  color: var(--muted);  border: 1px solid var(--border); }

  .pnl-pos { color: var(--green); }
  .pnl-neg { color: var(--red); }

  .logs-panel {
    grid-column: span 4;
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 2px;
    padding: 20px;
    box-shadow: 0 10px 24px var(--shadow);
  }
  .log-list { max-height: 180px; overflow-y: auto; scrollbar-width: thin; scrollbar-color: var(--border) transparent; }
  .log-entry { display: flex; gap: 16px; padding: 5px 0; border-bottom: 1px solid rgba(30,42,53,0.4); font-size: 11px; }
  .log-time { color: var(--muted); white-space: nowrap; }
  .log-level { width: 55px; text-align: center; }
  .log-level.INFO    { color: var(--accent); }
  .log-level.WARNING { color: var(--yellow); }
  .log-level.ERROR   { color: var(--red); }

  /* Coin Manager */
  .coin-manager {
    grid-column: span 4;
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 2px;
    padding: 20px;
    box-shadow: 0 10px 24px var(--shadow);
  }
  .coin-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 12px;
    margin-top: 16px;
  }
  .coin-card {
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: 2px;
    padding: 14px;
    display: flex;
    align-items: center;
    gap: 12px;
    transition: all 0.2s;
  }
  .coin-card:hover { border-color: var(--accent); }
  .coin-card.enabled { border-color: var(--green); background: rgba(0,255,136,0.03); }
  
  .coin-toggle {
    width: 36px;
    height: 20px;
    background: var(--border);
    border-radius: 10px;
    position: relative;
    cursor: pointer;
    transition: background 0.2s;
    flex-shrink: 0;
  }
  .coin-toggle.on { background: var(--green); }
  .coin-toggle::after {
    content: '';
    position: absolute;
    width: 16px;
    height: 16px;
    background: var(--text);
    border-radius: 50%;
    top: 2px;
    left: 2px;
    transition: transform 0.2s;
  }
  .coin-toggle.on::after { transform: translateX(16px); }
  
  .coin-info { flex: 1; }
  .coin-name {
    font-weight: 700;
    font-size: 13px;
    letter-spacing: 0.05em;
    color: var(--text);
  }
  .coin-params {
    display: flex;
    gap: 10px;
    margin-top: 4px;
  }
  .coin-input {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 2px;
    padding: 3px 6px;
    font-family: var(--font-mono);
    font-size: 11px;
    color: var(--text);
    width: 70px;
  }
  .coin-input:focus { outline: none; border-color: var(--accent); }

  .readiness {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 8px;
  }
  .readiness-label {
    font-size: 9px;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--muted);
  }
  .readiness-bar {
    flex: 1;
    height: 6px;
    background: rgba(30,42,53,0.7);
    border-radius: 6px;
    overflow: hidden;
  }
  .readiness-bar span {
    display: block;
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, rgba(0,229,255,0.2), rgba(0,255,136,0.8));
    transition: width 0.4s ease;
  }
  .readiness-val {
    font-size: 10px;
    color: var(--text);
  }

  .mini-btn {
    margin-top: 8px;
    padding: 6px 10px;
    border-radius: 2px;
    border: 1px solid rgba(255,210,48,0.4);
    background: rgba(255,210,48,0.08);
    color: var(--yellow);
    font-family: var(--font-mono);
    font-size: 10px;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.2s;
  }
  .mini-btn:hover { background: rgba(255,210,48,0.16); }
  
  .apply-btn {
    padding: 10px 24px;
    background: rgba(0,229,255,0.12);
    color: var(--accent);
    border: 1px solid rgba(0,229,255,0.35);
    border-radius: 2px;
    font-family: var(--font-mono);
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.2s;
    margin-top: 16px;
  }
  .apply-btn:hover { background: rgba(0,229,255,0.22); }
  .apply-btn:disabled { opacity: 0.35; cursor: not-allowed; }

  .loading { color: var(--muted); font-size: 12px; padding: 20px 0; text-align: center; }

  /* Toast notification */
  .toast {
    position: fixed;
    bottom: 28px;
    right: 28px;
    padding: 12px 20px;
    border-radius: 2px;
    font-size: 12px;
    font-family: var(--font-mono);
    letter-spacing: 0.05em;
    z-index: 10000;
    transform: translateY(80px);
    opacity: 0;
    transition: all 0.3s ease;
  }
  .toast.show { transform: translateY(0); opacity: 1; }
  .toast.success { background: rgba(0,255,136,0.15); color: var(--green); border: 1px solid rgba(0,255,136,0.3); }
  .toast.error   { background: rgba(255,59,92,0.15);  color: var(--red);   border: 1px solid rgba(255,59,92,0.3); }

  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  .card, .chart-panel, .table-panel, .logs-panel, .coin-manager { animation: fadeIn 0.5s ease forwards; }
</style>
</head>
<body>

<header>
  <div class="logo">ALGO<span>/</span>DESK</div>
  <div class="header-right">
    <div class="last-update" id="lastUpdate">—</div>
    <div class="status-pill">
      <div class="dot" id="statusDot"></div>
      <span id="statusText">CHECKING</span>
    </div>
    <button class="mode-btn" id="modeBtn" onclick="toggleMode()" disabled>
      MODE: —
    </button>
    <button class="toggle-btn start" id="toggleBtn" onclick="toggleBot()" disabled>
      ⏳ Loading
    </button>
  </div>
</header>

<main>
  <div class="stat-row">
    <div class="card accent">
      <div class="card-label">Wallet Balance</div>
      <div class="card-value accent" id="balance">—</div>
      <div class="card-sub" id="balanceSub">Futures wallet</div>
    </div>
    <div class="card green">
      <div class="card-label">Total PnL</div>
      <div class="card-value" id="totalPnl">—</div>
      <div class="card-sub">closed trades</div>
    </div>
    <div class="card">
      <div class="card-label">Win Rate</div>
      <div class="card-value" id="winRate">—</div>
      <div class="card-sub" id="winsLosses">— wins / — losses</div>
    </div>
    <div class="card yellow">
      <div class="card-label">Open Positions</div>
      <div class="card-value" id="openPositions">—</div>
      <div class="card-sub" id="totalTrades">— total trades</div>
    </div>
  </div>

  <div class="stat-row">
    <div class="card accent">
      <div class="card-label">Paper Balance</div>
      <div class="card-value accent" id="paperBalance">—</div>
      <div class="card-sub">paper wallet</div>
      <button class="mini-btn" onclick="resetPaperBalance()">Reset Paper Balance</button>
    </div>
    <div class="card green">
      <div class="card-label">Paper PnL</div>
      <div class="card-value" id="paperTotalPnl">—</div>
      <div class="card-sub">closed paper trades</div>
    </div>
    <div class="card">
      <div class="card-label">Paper Win Rate</div>
      <div class="card-value" id="paperWinRate">—</div>
      <div class="card-sub" id="paperWinsLosses">— wins / — losses</div>
    </div>
    <div class="card yellow">
      <div class="card-label">Paper Open</div>
      <div class="card-value" id="paperOpenPositions">—</div>
      <div class="card-sub" id="paperTotalTrades">— total trades</div>
    </div>
  </div>

  <div class="coin-manager">
    <div class="panel-title">
      Coin Manager — Select pairs to trade
      <div class="panel-tools">
        <input type="text" id="pairSearch" placeholder="Search pairs..." oninput="renderPairs()">
        <select id="pairListLimit" onchange="renderPairs()">
          <option value="80">Show 80</option>
          <option value="150">Show 150</option>
          <option value="1000">Show All</option>
        </select>
      </div>
    </div>
    <div class="coin-grid" id="coinGrid">
      <div class="loading">Loading available pairs...</div>
    </div>
    <button class="apply-btn" id="applyCoinsBtn" onclick="applyPairChanges()" disabled>Apply Changes & Restart Bots</button>
  </div>

  <div class="chart-panel wide">
    <div class="panel-title">
      Live Price — Selected Pair
      <div class="panel-tools">
        <select id="pairSelect" onchange="onPairChange()"></select>
      </div>
    </div>
    <div class="chart-wrap"><canvas id="priceChart"></canvas></div>
  </div>

  <div class="chart-panel side">
    <div class="panel-title">Pair PnL</div>
    <div class="chart-wrap"><canvas id="pairPnlChart"></canvas></div>
  </div>

  <div class="chart-panel wide">
    <div class="panel-title">Equity Curve</div>
    <div class="chart-wrap"><canvas id="equityChart"></canvas></div>
  </div>

  <div class="chart-panel side">
    <div class="panel-title">PnL / Trade</div>
    <div class="chart-wrap"><canvas id="pnlChart"></canvas></div>
  </div>

  <div class="table-panel">
    <div class="panel-title">Trade History</div>
    <table>
      <thead>
        <tr>
          <th>Pair</th><th>Side</th><th>Entry</th><th>Exit</th>
          <th>TP</th><th>SL</th><th>Qty</th><th>Lev</th>
          <th>PnL</th><th>Status</th><th>Opened</th>
        </tr>
      </thead>
      <tbody id="tradesBody">
        <tr><td colspan="11" class="loading">Loading trades...</td></tr>
      </tbody>
    </table>
  </div>

  <div class="table-panel">
    <div class="panel-title">Paper Trade History</div>
    <table>
      <thead>
        <tr>
          <th>Pair</th><th>Side</th><th>Entry</th><th>Exit</th>
          <th>TP</th><th>SL</th><th>Qty</th><th>Lev</th>
          <th>PnL</th><th>Status</th><th>Opened</th>
        </tr>
      </thead>
      <tbody id="paperTradesBody">
        <tr><td colspan="11" class="loading">Loading paper trades...</td></tr>
      </tbody>
    </table>
  </div>

  <div class="logs-panel">
    <div class="panel-title">Bot Logs</div>
    <div class="log-list" id="logList">
      <div class="loading">Loading logs...</div>
    </div>
  </div>
</main>

<div class="toast" id="toast"></div>

<script>
const API = '';  // empty = same host, goes through Nginx proxy
const REFRESH_MS = 5000;

let equityChart, pnlChart, priceChart, pairPnlChart;
let botRunning = false;
let pairConfigs = {}; // Store current pair configurations
let tradingMode = 'REAL';
let pairsList = [];
let allPairs = [];
let selectedPair = '';
let latestTrades = [];
let latestPaperTrades = [];

function showToast(msg, type = 'success') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = `toast ${type} show`;
  setTimeout(() => t.classList.remove('show'), 3000);
}

// ── Trading mode ─────────────────────────
async function fetchMode() {
  try {
    const resp = await fetch(API + '/api/mode');
    const data = await resp.json();
    tradingMode = (data.mode || 'REAL').toUpperCase();
    renderMode();
  } catch (e) {
    // keep previous mode
  }
}

function renderMode() {
  const btn = document.getElementById('modeBtn');
  btn.textContent = `MODE: ${tradingMode}`;
  btn.className = `mode-btn ${tradingMode === 'PAPER' ? 'paper' : 'real'}`;
  btn.disabled = false;
}

async function toggleMode() {
  const nextMode = tradingMode === 'PAPER' ? 'REAL' : 'PAPER';
  const btn = document.getElementById('modeBtn');
  btn.disabled = true;
  btn.textContent = 'MODE: ...';

  try {
    const resp = await fetch(API + '/api/mode', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ mode: nextMode })
    });
    const data = await resp.json();
    if (data.success) {
      tradingMode = data.mode;
      renderMode();
      showToast(`Mode switched to ${data.mode}`, 'success');
    } else {
      showToast(data.error || 'Failed to switch mode', 'error');
    }
  } catch (e) {
    showToast('Failed to switch mode', 'error');
  } finally {
    btn.disabled = false;
  }
}

// ── Bot toggle ────────────────────────────
async function toggleBot() {
  const btn = document.getElementById('toggleBtn');
  btn.disabled = true;

  const endpoint = botRunning ? '/api/bot/stop' : '/api/bot/start';
  const action   = botRunning ? 'Stopping...' : 'Starting...';
  btn.textContent = action;

  try {
    const resp = await fetch(API + endpoint, { method: 'POST' });
    const data = await resp.json();
    if (data.success) {
      showToast(data.message, 'success');
      setTimeout(checkBotStatus, 1500);
    } else {
      showToast(data.message || 'Failed', 'error');
      btn.disabled = false;
    }
  } catch (e) {
    showToast('Request failed', 'error');
    btn.disabled = false;
  }
}

async function checkBotStatus() {
  try {
    const resp = await fetch(API + '/api/bot/status');
    const data = await resp.json();
    botRunning = data.running;

    const btn = document.getElementById('toggleBtn');
    const dot = document.getElementById('statusDot');
    const txt = document.getElementById('statusText');

    if (botRunning) {
      btn.textContent = '⏹ Stop Bot';
      btn.className = 'toggle-btn stop';
      dot.className = 'dot live';
      txt.textContent = 'LIVE';
    } else {
      btn.textContent = '▶ Start Bot';
      btn.className = 'toggle-btn start';
      dot.className = 'dot stopped';
      txt.textContent = 'STOPPED';
    }
    btn.disabled = false;
  } catch (e) {
    document.getElementById('statusText').textContent = 'OFFLINE';
  }
}

// ── Charts ────────────────────────────────
function initCharts() {
  const baseOpts = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: { legend: { display: false } },
    scales: {
      x: {
        ticks: { color: '#4a6070', font: { family: 'Space Mono', size: 10 }, maxTicksLimit: 6 },
        grid:  { color: 'rgba(30,42,53,0.6)' },
        border: { color: '#1e2a35' }
      },
      y: {
        ticks: { color: '#4a6070', font: { family: 'Space Mono', size: 10 } },
        grid:  { color: 'rgba(30,42,53,0.6)' },
        border: { color: '#1e2a35' }
      }
    }
  };

  equityChart = new Chart(document.getElementById('equityChart'), {
    type: 'line',
    data: { labels: [], datasets: [{ data: [], borderColor: '#00e5ff', backgroundColor: 'rgba(0,229,255,0.06)', borderWidth: 2, fill: true, tension: 0.3, pointRadius: 0 }] },
    options: { ...baseOpts }
  });

  pnlChart = new Chart(document.getElementById('pnlChart'), {
    type: 'bar',
    data: { labels: [], datasets: [{ data: [], backgroundColor: ctx => ctx.raw >= 0 ? 'rgba(0,255,136,0.7)' : 'rgba(255,59,92,0.7)', borderRadius: 2 }] },
    options: { ...baseOpts }
  });

  priceChart = new Chart(document.getElementById('priceChart'), {
    type: 'line',
    data: { labels: [], datasets: [
      { label: 'Price', data: [], borderColor: '#00e5ff', backgroundColor: 'rgba(0,229,255,0.08)', borderWidth: 2, fill: true, tension: 0.2, pointRadius: 0 },
      { label: 'Real Trades', type: 'scatter', data: [], pointRadius: 5, pointBackgroundColor: '#00ff88' },
      { label: 'Paper Trades', type: 'scatter', data: [], pointRadius: 5, pointBackgroundColor: '#ffd230' },
    ] },
    options: { ...baseOpts, plugins: { legend: { display: true, labels: { color: '#4a6070', font: { family: 'Space Mono', size: 10 } } } } }
  });

  pairPnlChart = new Chart(document.getElementById('pairPnlChart'), {
    type: 'line',
    data: { labels: [], datasets: [{ data: [], borderColor: '#00ff88', backgroundColor: 'rgba(0,255,136,0.1)', borderWidth: 2, fill: true, tension: 0.25, pointRadius: 0 }] },
    options: { ...baseOpts }
  });

  priceChart = new Chart(document.getElementById('priceChart'), {
    type: 'line',
    data: { labels: [], datasets: [
      { label: 'Price', data: [], borderColor: '#00e5ff', backgroundColor: 'rgba(0,229,255,0.08)', borderWidth: 2, fill: true, tension: 0.2, pointRadius: 0 },
      { label: 'Real Trades', type: 'scatter', data: [], pointRadius: 5, pointBackgroundColor: '#00ff88' },
      { label: 'Paper Trades', type: 'scatter', data: [], pointRadius: 5, pointBackgroundColor: '#ffd230' },
    ] },
    options: { ...baseOpts, plugins: { legend: { display: true, labels: { color: '#4a6070', font: { family: 'Space Mono', size: 10 } } } } }
  });

  pairPnlChart = new Chart(document.getElementById('pairPnlChart'), {
    type: 'line',
    data: { labels: [], datasets: [{ data: [], borderColor: '#00ff88', backgroundColor: 'rgba(0,255,136,0.1)', borderWidth: 2, fill: true, tension: 0.25, pointRadius: 0 }] },
    options: { ...baseOpts }
  });
}

// ── Data fetch ────────────────────────────
async function fetchAll() {
  try {
    const [stats, equity, trades, logs, paperStats, paperTrades] = await Promise.all([
      fetch(API + '/api/stats').then(r => r.json()),
      fetch(API + '/api/equity').then(r => r.json()),
      fetch(API + '/api/trades').then(r => r.json()),
      fetch(API + '/api/logs').then(r => r.json()),
      fetch(API + '/api/paper/stats').then(r => r.json()),
      fetch(API + '/api/paper/trades').then(r => r.json()),
    ]);

    // Balance via status
    fetch(API + '/api/status').then(r => r.json()).then(s => {
      const numericBalance = Number(s.balance);
      const currency = String(s.balance_currency || '').toUpperCase();
      const symbol = currency === 'INR' ? '₹' : currency === 'USDT' || currency === 'USD' ? '$' : '';
      document.getElementById('balance').textContent = Number.isFinite(numericBalance)
        ? `${symbol}${numericBalance.toFixed(2)}${symbol ? '' : ' ' + (currency || '')}`
        : '—';
      document.getElementById('balanceSub').textContent = currency ? `${currency} futures` : 'Futures wallet';
      document.getElementById('openPositions').textContent = s.open_trades ?? 0;

      const paperBal = Number(s.paper_balance);
      document.getElementById('paperBalance').textContent = Number.isFinite(paperBal)
        ? `${symbol}${paperBal.toFixed(2)}${symbol ? '' : ' ' + (currency || '')}`
        : '—';
    });

    latestTrades = trades || [];
    latestPaperTrades = paperTrades || [];

    renderStats(stats);
    renderEquity(equity);
    renderTrades(trades);
    renderPnlChart(trades);
    renderLogs(logs);
    renderPaperStats(paperStats, paperTrades);
    renderPaperTrades(paperTrades);
    updatePairPnlChart();

    document.getElementById('lastUpdate').textContent = 'Updated ' + new Date().toLocaleTimeString();
  } catch (e) {
    console.error('Fetch error:', e);
  }
}

function renderStats(s) {
  const pnl = s.total_pnl ?? 0;
  const el  = document.getElementById('totalPnl');
  el.textContent = (pnl >= 0 ? '+' : '') + pnl.toFixed(4) + ' USDT';
  el.className   = 'card-value ' + (pnl >= 0 ? 'green' : 'red');
  document.getElementById('winRate').textContent    = (s.win_rate ?? 0) + '%';
  document.getElementById('winsLosses').textContent  = `${s.wins ?? 0} wins / ${s.losses ?? 0} losses`;
  document.getElementById('totalTrades').textContent = `${s.total ?? 0} total trades`;
}

function renderPaperStats(s, trades) {
  const pnl = s.total_pnl ?? 0;
  const el  = document.getElementById('paperTotalPnl');
  el.textContent = (pnl >= 0 ? '+' : '') + pnl.toFixed(4) + ' USDT';
  el.className   = 'card-value ' + (pnl >= 0 ? 'green' : 'red');
  document.getElementById('paperWinRate').textContent    = (s.win_rate ?? 0) + '%';
  document.getElementById('paperWinsLosses').textContent  = `${s.wins ?? 0} wins / ${s.losses ?? 0} losses`;
  document.getElementById('paperTotalTrades').textContent = `${s.total ?? 0} total trades`;

  const open = Array.isArray(trades) ? trades.filter(t => t.status === 'open').length : 0;
  document.getElementById('paperOpenPositions').textContent = open;
}

function renderEquity(data) {
  if (!data.length) return;
  equityChart.data.labels = data.map(d => d.created_at.slice(11, 16));
  equityChart.data.datasets[0].data = data.map(d => d.balance);
  equityChart.update('none');
}

function renderTrades(trades) {
  const tbody = document.getElementById('tradesBody');
  if (!trades.length) { tbody.innerHTML = '<tr><td colspan="11" class="loading">No trades yet</td></tr>'; return; }
  tbody.innerHTML = trades.map(t => {
    const pnl    = t.pnl != null ? parseFloat(t.pnl).toFixed(4) : '—';
    const pnlCls = t.pnl > 0 ? 'pnl-pos' : t.pnl < 0 ? 'pnl-neg' : '';
    const opened = t.opened_at ? t.opened_at.slice(0, 16).replace('T', ' ') : '—';
    return `<tr>
      <td>${t.pair}</td>
      <td><span class="badge ${t.side}">${t.side.toUpperCase()}</span></td>
      <td>${t.entry_price ?? '—'}</td>
      <td>${t.exit_price ?? '—'}</td>
      <td>${t.tp_price ?? '—'}</td>
      <td>${t.sl_price ?? '—'}</td>
      <td>${t.quantity ?? '—'}</td>
      <td>${t.leverage ?? '—'}x</td>
      <td class="${pnlCls}">${pnl !== '—' ? (t.pnl > 0 ? '+' : '') + pnl : '—'}</td>
      <td><span class="badge ${t.status}">${t.status}</span></td>
      <td>${opened}</td>
    </tr>`;
  }).join('');
}

function renderPaperTrades(trades) {
  const tbody = document.getElementById('paperTradesBody');
  if (!trades.length) { tbody.innerHTML = '<tr><td colspan="11" class="loading">No paper trades yet</td></tr>'; return; }
  tbody.innerHTML = trades.map(t => {
    const pnl    = t.pnl != null ? parseFloat(t.pnl).toFixed(4) : '—';
    const pnlCls = t.pnl > 0 ? 'pnl-pos' : t.pnl < 0 ? 'pnl-neg' : '';
    const opened = t.opened_at ? t.opened_at.slice(0, 16).replace('T', ' ') : '—';
    return `<tr>
      <td>${t.pair}</td>
      <td><span class="badge ${t.side}">${t.side.toUpperCase()}</span></td>
      <td>${t.entry_price ?? '—'}</td>
      <td>${t.exit_price ?? '—'}</td>
      <td>${t.tp_price ?? '—'}</td>
      <td>${t.sl_price ?? '—'}</td>
      <td>${t.quantity ?? '—'}</td>
      <td>${t.leverage ?? '—'}x</td>
      <td class="${pnlCls}">${pnl !== '—' ? (t.pnl > 0 ? '+' : '') + pnl : '—'}</td>
      <td><span class="badge ${t.status}">${t.status}</span></td>
      <td>${opened}</td>
    </tr>`;
  }).join('');
}

function renderPnlChart(trades) {
  const closed = trades.filter(t => t.status === 'closed' && t.pnl != null).slice(-20);
  if (!closed.length) return;
  pnlChart.data.labels = closed.map((_, i) => `T${i + 1}`);
  pnlChart.data.datasets[0].data = closed.map(t => parseFloat(t.pnl));
  pnlChart.update('none');
}

function renderLogs(logs) {
  const el = document.getElementById('logList');
  if (!logs.length) { el.innerHTML = '<div class="loading">No logs yet</div>'; return; }
  el.innerHTML = logs.map(l => `
    <div class="log-entry">
      <span class="log-time">${l.created_at ? l.created_at.slice(11, 19) : ''}</span>
      <span class="log-level ${l.level}">${l.level}</span>
      <span class="log-msg">${l.message}</span>
    </div>
  `).join('');
}

// ── Coin Manager ──────────────────────────
async function loadPairs() {
  try {
    const [available, configs] = await Promise.all([
      fetch(API + '/api/pairs/available').then(r => r.json()),
      fetch(API + '/api/pairs/config').then(r => r.json())
    ]);

    // Build config map
    const configMap = {};
    configs.forEach(c => {
      configMap[c.pair] = { enabled: c.enabled, leverage: c.leverage, quantity: c.quantity };
    });

    // Render coin grid
    const grid = document.getElementById('coinGrid');
    if (!available || !available.length) {
      grid.innerHTML = '<div class="loading">No pairs available</div>';
      return;
    }

    // Filter to common USDT pairs
    const popularPairs = ['B-BTC_USDT', 'B-ETH_USDT', 'B-SOL_USDT', 'B-XRP_USDT', 'B-BNB_USDT', 
                          'B-ADA_USDT', 'B-DOGE_USDT', 'B-MATIC_USDT', 'B-DOT_USDT', 'B-AVAX_USDT'];
    const pairs = available.filter(p => popularPairs.includes(p.pair)).slice(0, 12);
    pairsList = pairs.map(p => p.pair);

    grid.innerHTML = pairs.map(p => {
      const cfg = configMap[p.pair] || { enabled: 0, leverage: 5, quantity: 0.001 };
      pairConfigs[p.pair] = cfg;
      
      const baseCoin = p.pair.replace('B-', '').replace('_USDT', '');
      const enabled = cfg.enabled === 1;
      
      return `
        <div class="coin-card ${enabled ? 'enabled' : ''}" data-pair="${p.pair}">
          <div class="coin-toggle ${enabled ? 'on' : ''}" onclick="togglePair('${p.pair}')"></div>
          <div class="coin-info">
            <div class="coin-name">${baseCoin}/USDT</div>
            <div class="coin-manager">
              <div class="panel-title">
                Coin Manager — Select pairs to trade
                <div class="panel-tools">
                  <input type="text" id="pairSearch" placeholder="Search pairs..." oninput="renderPairs()">
                  <select id="pairListLimit" onchange="renderPairs()">
                    <option value="80">Show 80</option>
                    <option value="150">Show 150</option>
                    <option value="1000">Show All</option>
                  </select>
                </div>
              </div>
              <div class="coin-grid" id="coinGrid">
                <div class="loading">Loading available pairs...</div>
              </div>
              <button class="apply-btn" id="applyCoinsBtn" onclick="applyPairChanges()" disabled>Apply Changes & Restart Bots</button>
            </div>

            <div class="chart-panel wide">
              <div class="panel-title">
                Live Price — Selected Pair
                <div class="panel-tools">
                  <select id="pairSelect" onchange="onPairChange()"></select>
                </div>
              </div>
              <div class="chart-wrap"><canvas id="priceChart"></canvas></div>
            </div>

            <div class="chart-panel side">
              <div class="panel-title">Pair PnL</div>
              <div class="chart-wrap"><canvas id="pairPnlChart"></canvas></div>
            </div>

            <div class="chart-panel wide">
              <div class="panel-title">Equity Curve</div>
              <div class="chart-wrap"><canvas id="equityChart"></canvas></div>
            </div>

            <div class="chart-panel side">
              <div class="panel-title">PnL / Trade</div>
              <div class="chart-wrap"><canvas id="pnlChart"></canvas></div>
            </div>

    document.getElementById('applyCoinsBtn').disabled = false;
    allPairs = available || [];

    renderPairs();
    updatePairSelect();
    document.getElementById('applyCoinsBtn').disabled = false;
    updateReadiness();

    const data = await resp.json();
    if (data.success) {
      showToast('Pair settings updated! Restart bots to apply.', 'success');
      

function renderPairs() {
  const grid = document.getElementById('coinGrid');
  const query = (document.getElementById('pairSearch')?.value || '').toUpperCase();
  const limit = parseInt(document.getElementById('pairListLimit')?.value || '80', 10);
  const filtered = allPairs.filter(p => p.pair.includes(query));
  const pairs = filtered.slice(0, limit);
  pairsList = pairs.map(p => p.pair);

  if (!pairs.length) {
    grid.innerHTML = '<div class="loading">No pairs match search</div>';
    return;
  }

  grid.innerHTML = pairs.map(p => {
    const cfg = pairConfigs[p.pair] || { enabled: 0, leverage: 5, quantity: 0.001 };
    pairConfigs[p.pair] = cfg;

    const baseCoin = p.pair.replace('B-', '').replace('_USDT', '');
    const enabled = cfg.enabled === 1;

    return `
      <div class="coin-card ${enabled ? 'enabled' : ''}" data-pair="${p.pair}">
        <div class="coin-toggle ${enabled ? 'on' : ''}" onclick="togglePair('${p.pair}')"></div>
        <div class="coin-info">
          <div class="coin-name">${baseCoin}/USDT</div>
          <div class="coin-params">
            <input type="number" class="coin-input" placeholder="Lev" 
                   value="${cfg.leverage}" min="1" max="20" 
                   onchange="updatePairConfig('${p.pair}', 'leverage', this.value)">
            <input type="number" class="coin-input" placeholder="Qty" 
                   value="${cfg.quantity}" step="0.001" min="0.001"
                   onchange="updatePairConfig('${p.pair}', 'quantity', this.value)">
          </div>
          <div class="readiness">
            <span class="readiness-label">Signal</span>
            <div class="readiness-bar"><span data-readiness="${p.pair}"></span></div>
            <span class="readiness-val" data-readiness-val="${p.pair}">—</span>
          </div>
        </div>
      </div>
    `;
  }).join('');

  updateReadiness();
}

function updatePairSelect() {
  const select = document.getElementById('pairSelect');
  if (!select || !allPairs.length) return;

  const enabled = Object.keys(pairConfigs).filter(p => pairConfigs[p]?.enabled === 1);
  const list = enabled.length ? enabled : allPairs.map(p => p.pair);

  select.innerHTML = list.map(p => `<option value="${p}">${p.replace('B-', '').replace('_USDT','')}/USDT</option>`).join('');

  if (!selectedPair) {
    selectedPair = list[0] || '';
  }
  select.value = selectedPair;
  updatePriceChart();
}

function onPairChange() {
  const select = document.getElementById('pairSelect');
  selectedPair = select.value;
  updatePriceChart();
  updatePairPnlChart();
}

async function updatePriceChart() {
  if (!selectedPair) return;
  try {
    const resp = await fetch(API + `/api/candles?pair=${encodeURIComponent(selectedPair)}&limit=200`);
    const candles = await resp.json();
    const labels = candles.map(c => (c.timestamp || c.t || '').toString().slice(11, 16));
    const prices = candles.map(c => Number(c.close ?? c.c ?? 0));

    priceChart.data.labels = labels;
    priceChart.data.datasets[0].data = prices;

    const tradeMarks = buildTradeMarks(selectedPair, candles, latestTrades);
    const paperMarks = buildTradeMarks(selectedPair, candles, latestPaperTrades);
    priceChart.data.datasets[1].data = tradeMarks;
    priceChart.data.datasets[2].data = paperMarks;
    priceChart.update('none');
  } catch (e) {
    // ignore chart errors
  }
}

function buildTradeMarks(pair, candles, trades) {
  if (!Array.isArray(trades)) return [];
  const marks = [];
  const labels = candles.map(c => (c.timestamp || c.t || '').toString().slice(11, 16));

  trades.filter(t => t.pair === pair).forEach(t => {
    const entry = t.entry_price;
    if (entry != null) {
      const idx = findNearestIndex(candles, t.opened_at);
      if (idx !== -1) {
        marks.push({ x: labels[idx], y: entry });
      }
    }
    if (t.status === 'closed' && t.exit_price != null) {
      const idx = findNearestIndex(candles, t.closed_at || t.opened_at);
      if (idx !== -1) {
        marks.push({ x: labels[idx], y: t.exit_price });
      }
    }
  });
  return marks;
}

function findNearestIndex(candles, isoTime) {
  if (!isoTime) return -1;
  const target = new Date(isoTime).getTime();
  let best = -1;
  let bestDiff = Infinity;
  candles.forEach((c, i) => {
    const ts = new Date(c.timestamp || c.t || 0).getTime();
    const diff = Math.abs(ts - target);
    if (diff < bestDiff) {
      bestDiff = diff;
      best = i;
    }
  });
  return best;
}

function updatePairPnlChart() {
  if (!selectedPair) return;
  const closed = latestTrades.filter(t => t.pair === selectedPair && t.status === 'closed' && t.pnl != null);
  const pnlSeries = [];
  let total = 0;
  closed.slice(-50).forEach((t) => {
    total += parseFloat(t.pnl);
    pnlSeries.push(total);
  });

  pairPnlChart.data.labels = pnlSeries.map((_, i) => `T${i + 1}`);
  pairPnlChart.data.datasets[0].data = pnlSeries;
  pairPnlChart.update('none');
}
      // Auto-restart if bot is running
      if (botRunning) {
        setTimeout(async () => {
          await fetch(API + '/api/bot/stop', { method: 'POST' });
          setTimeout(() => fetch(API + '/api/bot/start', { method: 'POST' }), 2000);
        }, 1000);
      }
    } else {
      showToast(data.error || 'Failed to update settings', 'error');
    }
  } catch (e) {
    showToast('Request failed', 'error');
  } finally {
    btn.disabled = false;
    btn.textContent = 'Apply Changes & Restart Bots';
  }
}

async function updateReadiness() {
  if (!pairsList.length) return;
  try {
    const resp = await fetch(API + '/api/signal/readiness?pairs=' + encodeURIComponent(pairsList.join(',')));
    const data = await resp.json();
    data.forEach(item => {
      const bar = document.querySelector(`[data-readiness="${item.pair}"]`);
      const val = document.querySelector(`[data-readiness-val="${item.pair}"]`);
      if (!bar || !val) return;
      const pct = Math.min(100, Math.max(0, item.readiness || 0));
      bar.style.width = pct + '%';
      val.textContent = `${pct}% ${item.bias}`;
    });
  } catch (e) {
    // ignore readiness errors
  }
}

async function resetPaperBalance() {
  try {
    const resp = await fetch(API + '/api/paper/reset', { method: 'POST' });
    const data = await resp.json();
    if (data.success) {
      showToast('Paper balance reset', 'success');
      fetchAll();
    } else {
      showToast('Failed to reset paper balance', 'error');
    }
  } catch (e) {
    showToast('Failed to reset paper balance', 'error');
  }
}

// ── Boot ──────────────────────────────────
initCharts();
loadPairs();
fetchMode();
checkBotStatus();
fetchAll();
setInterval(fetchAll, REFRESH_MS);
setInterval(checkBotStatus, REFRESH_MS);
setInterval(updateReadiness, REFRESH_MS * 2);
setInterval(updatePriceChart, REFRESH_MS * 2);
setInterval(updatePriceChart, REFRESH_MS * 2);
</script>
</body>
</html>
